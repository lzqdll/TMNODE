const https = require('http');
const StringDecoder = require('string_decoder').StringDecoder;
const decoder = new StringDecoder('utf8');
var querystring = require('querystring');
const lbtargetpath = '/TM/cp/cpgetleavebalance.action?searchTable=leavebalance';
const vacationAddingpath = '/TM/cp/cpgetleavebalance.action?searchTable=leavebalance';
const ssologin = '/TM/cp/ssologin.action?';
var pathoptions = {
	hostname : 'localhost',
	port : 8080
	//	path : '/TM/cp/cpgetleavebalance.action?searchTable=leavebalance',
	//method : 'GET'
};
get=function (pathoptions, cb) {
	pathoptions.method = 'GET';
	https.get(pathoptions, function (response) {
		if (response.statusCode === 200) {
			var body = '';
			response.on('data', function (data) {
				body += data;
			}).on('end', function () {
				var result = JSON.parse(body);
				if (result && 0 === result.errcode) {
					cb.success(result);
				} else {
					cb.error(result);
				}
			});
		} else {
			cb.error(response.statusCode);
		}
	});
},

post= function (pathoptions, data, cb) {
	console.log(data);
	//console.log(querystring.stringify(data) );
	pathoptions.method = 'POST';
	pathoptions.headers = {
		'Content-Type' : 'application/json'
	};
	pathoptions.path += 'mobile='+data;
	console.log(pathoptions.path);
	var req = https.request(pathoptions, function (response) {
			if (response.statusCode === 200) {
				var body = '';
				response.on('data', function (data) {
					body += data;
				}).on('end', function () {
					var result = JSON.parse(body);
					console.log(result);
					if (result && 0 === result.errcode) {
						cb.success(result);
					} else {
						cb.error(result);
					}
				});
			} else {
				cb.error(response.statusCode);
			}
		});
	req.write(data + '\n');
	req.end();
}
module.exports = {
	SSOlogin : function (mobile, callback) {
		console.log("SSOLOGIN start");
		pathoptions.path=ssologin;
		post(pathoptions,mobile,callback);
	},
	getleavebalance : function (user, tt, callback) {
		pathoptions.path = lbtargetpath + '&userid=' + user.id;
		get(pathoptions, callback);
		//console.log('leavebalance.js user id: '+ user.id);
		//console.log('$$$$$$$$$$$OPTION PATH:'+options.path);
		/* 	var a = https.request(options, function (res) {
		//console.log('statusCode: ', res.statusCode);
		//console.log('headers: ', res.headers);
		res.on('data', function (d) {
		tokenid = decoder.write(d)
		callback(tokenid);
		});
		})
		a.end(); */
	},
	vacationAdding : function (user, obj, callback) {
		//console.log('leavebalance.js user id: '+ user.id);
		pathoptions.path = vacationAddingpath + '&userid=' + user.id;
		post(pathoptions, obj, callback);
		//console.log('$$$$$$$$$$$OPTION PATH:'+options.path);
		/* 	var a = https.request(options, function (res) {
		//console.log('statusCode: ', res.statusCode);
		//console.log('headers: ', res.headers);
		res.on('data', function (d) {
		tokenid = decoder.write(d)
		callback(tokenid);
		});
		})
		a.end(); */
	}
	
}
